{% extends "base.html" %}

{% block title %}Maps - Meshtopo Gateway{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-map"></i> CalTopo Maps</h2>
            <div>
                <button class="btn btn-outline-primary" onclick="refreshMaps()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
                {% if team_api_enabled %}
                <button class="btn btn-primary" onclick="showCreateMapModal()">
                    <i class="fas fa-plus"></i> Create Map
                </button>
                {% endif %}
            </div>
        </div>

        {% if error %}
        <div class="alert alert-danger" role="alert">
            <i class="fas fa-exclamation-triangle"></i> {{ error }}
        </div>
        {% endif %}

        {% if not team_api_enabled %}
        <div class="alert alert-warning" role="alert">
            <i class="fas fa-exclamation-triangle"></i>
            CalTopo Team API is not enabled. Enable it in the configuration to manage maps.
        </div>
        {% endif %}

        <!-- Current Map Status -->
        {% if current_map %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-check-circle text-success"></i> Currently Selected Map
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h6>{{ current_map.name or current_map.map_id }}</h6>
                        <p class="text-muted mb-0">
                            <strong>Map ID:</strong> {{ current_map.map_id }}<br>
                            <strong>Group:</strong> {{ current_map.group }}<br>
                            {% if current_map.description %}
                            <strong>Description:</strong> {{ current_map.description }}
                            {% endif %}
                        </p>
                    </div>
                    <div class="col-md-4 text-end">
                        <span class="badge bg-success fs-6">
                            <i class="fas fa-satellite-dish"></i> Active
                        </span>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Available Maps -->
        <div class="row" id="maps-container">
            {% if maps %}
                {% for map in maps %}
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card map-card h-100 {{ 'selected' if current_map and current_map.map_id == map.id }}">
                        <div class="card-body">
                            <h6 class="card-title">
                                <i class="fas fa-map-marked-alt"></i> {{ map.name or map.id }}
                            </h6>
                            <p class="card-text text-muted small">
                                <strong>ID:</strong> {{ map.id }}<br>
                                {% if map.description %}
                                {{ map.description[:100] }}{% if map.description|length > 100 %}...{% endif %}<br>
                                {% endif %}
                                <strong>Created:</strong> {{ map.created_at[:10] if map.created_at else 'Unknown' }}
                            </p>
                        </div>
                        <div class="card-footer">
                            <div class="d-flex justify-content-between">
                                <button class="btn btn-sm btn-outline-primary" onclick="viewMapDetails('{{ map.id }}')">
                                    <i class="fas fa-eye"></i> Details
                                </button>
                                {% if not current_map or current_map.map_id != map.id %}
                                <button class="btn btn-sm btn-success" onclick="selectMap('{{ map.id }}')">
                                    <i class="fas fa-check"></i> Select
                                </button>
                                {% else %}
                                <span class="badge bg-success">
                                    <i class="fas fa-check"></i> Selected
                                </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="col-12">
                    <div class="text-center py-5">
                        <i class="fas fa-map fa-3x text-muted mb-3"></i>
                        <h4 class="text-muted">No Maps Available</h4>
                        <p class="text-muted">
                            {% if team_api_enabled %}
                            No maps found in your CalTopo account. Create a new map to get started.
                            {% else %}
                            Enable CalTopo Team API in the configuration to manage maps.
                            {% endif %}
                        </p>
                        {% if team_api_enabled %}
                        <button class="btn btn-primary" onclick="showCreateMapModal()">
                            <i class="fas fa-plus"></i> Create Your First Map
                        </button>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Map Details Modal -->
<div class="modal fade" id="mapDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-map-marked-alt"></i> Map Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="mapDetailsContent">
                <!-- Map details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="selectMapFromDetails">Select This Map</button>
            </div>
        </div>
    </div>
</div>

<!-- Create Map Modal -->
<div class="modal fade" id="createMapModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus"></i> Create New Map
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createMapForm">
                    <div class="mb-3">
                        <label for="mapName" class="form-label">Map Name</label>
                        <input type="text" class="form-control" id="mapName" required>
                    </div>
                    <div class="mb-3">
                        <label for="mapDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="mapDescription" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createMap()">Create Map</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentMapId = null;

// Refresh maps list
async function refreshMaps() {
    try {
        const response = await fetch('{{ url_for("maps.list_maps") }}');
        const data = await response.json();

        if (response.ok) {
            location.reload(); // Simple refresh for now
        } else {
            alert('Failed to refresh maps: ' + data.error);
        }
    } catch (error) {
        console.error('Refresh error:', error);
        alert('Failed to refresh maps');
    }
}

// Select a map
async function selectMap(mapId) {
    try {
        const response = await fetch('{{ url_for("maps.select_map") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ map_id: mapId })
        });

        const data = await response.json();

        if (response.ok) {
            location.reload(); // Refresh to show updated selection
        } else {
            alert('Failed to select map: ' + data.error);
        }
    } catch (error) {
        console.error('Select map error:', error);
        alert('Failed to select map');
    }
}

// View map details
async function viewMapDetails(mapId) {
    try {
        const response = await fetch(`{{ url_for("maps.map_details", map_id="") }}${mapId}`);
        const data = await response.json();

        if (response.ok) {
            currentMapId = mapId;
            displayMapDetails(data.map);
            const modal = new bootstrap.Modal(document.getElementById('mapDetailsModal'));
            modal.show();
        } else {
            alert('Failed to load map details: ' + data.error);
        }
    } catch (error) {
        console.error('Map details error:', error);
        alert('Failed to load map details');
    }
}

// Display map details in modal
function displayMapDetails(map) {
    const content = document.getElementById('mapDetailsContent');
    content.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>Basic Information</h6>
                <p><strong>Name:</strong> ${map.name || map.id}</p>
                <p><strong>ID:</strong> ${map.id}</p>
                <p><strong>Created:</strong> ${map.created_at || 'Unknown'}</p>
                ${map.description ? `<p><strong>Description:</strong> ${map.description}</p>` : ''}
            </div>
            <div class="col-md-6">
                <h6>Status</h6>
                <p><strong>Status:</strong> <span class="badge bg-success">Active</span></p>
                <p><strong>Team API:</strong> <span class="badge bg-info">Enabled</span></p>
            </div>
        </div>
    `;
}

// Show create map modal
function showCreateMapModal() {
    const modal = new bootstrap.Modal(document.getElementById('createMapModal'));
    modal.show();
}

// Create new map
async function createMap() {
    const name = document.getElementById('mapName').value;
    const description = document.getElementById('mapDescription').value;

    if (!name) {
        alert('Map name is required');
        return;
    }

    try {
        const response = await fetch('{{ url_for("api.create_map") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: name,
                description: description
            })
        });

        const data = await response.json();

        if (response.ok) {
            alert('Map created successfully');
            location.reload();
        } else {
            alert('Failed to create map: ' + data.error);
        }
    } catch (error) {
        console.error('Create map error:', error);
        alert('Failed to create map');
    }
}

// Select map from details modal
document.getElementById('selectMapFromDetails').addEventListener('click', function() {
    if (currentMapId) {
        selectMap(currentMapId);
        const modal = bootstrap.Modal.getInstance(document.getElementById('mapDetailsModal'));
        modal.hide();
    }
});
</script>
{% endblock %}
