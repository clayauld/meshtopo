name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read
  packages: write
  pull-requests: write
  checks: write

jobs:
  test:
    name: üß™ Test Suite
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-${{ matrix.python-version }}-
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-asyncio

    - name: Run pytest with coverage
      id: pytest
      run: |
        python -m pytest tests/ -v --cov=src --cov-report=xml --cov-report=term-missing --junitxml=pytest-results.xml

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

    - name: Publish Test Report
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: 'Test Results (Python ${{ matrix.python-version }})'
        path: pytest-results.xml
        reporter: java-junit
        fail-on-error: false

  lint:
    name: üîç Code Quality
    runs-on: ubuntu-latest
    if: always()

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort mypy bandit types-PyYAML types-requests types-WTForms

    - name: Run Black (code formatting check)
      id: black
      run: |
        black --check --diff src/ tests/ > black-results.txt 2>&1 || echo "BLACK_FAILED=true" >> $GITHUB_ENV
      continue-on-error: true

    - name: Run Flake8 (code quality check)
      id: flake8
      run: |
        flake8 src/ tests/ --max-line-length=88 --extend-ignore=E203,W503 --output-file=flake8-results.txt || echo "FLAKE8_FAILED=true" >> $GITHUB_ENV
      continue-on-error: true

    - name: Run isort (import sorting check)
      id: isort
      run: |
        isort --check-only --diff --profile=black src/ tests/ > isort-results.txt 2>&1 || echo "ISORT_FAILED=true" >> $GITHUB_ENV
      continue-on-error: true

    - name: Run MyPy (type checking)
      id: mypy
      run: |
        mypy src/ --ignore-missing-imports --no-error-summary > mypy-results.txt 2>&1 || echo "MYPY_FAILED=true" >> $GITHUB_ENV
      continue-on-error: true

    - name: Run Bandit (security check)
      id: bandit
      run: |
        bandit -r -f json src/ > bandit-results.json || echo "BANDIT_FAILED=true" >> $GITHUB_ENV
      continue-on-error: true

    - name: Create lint results summary
      if: always()
      run: |
        echo "## üîç Linting Results Summary" > lint-summary.md
        echo "" >> lint-summary.md

        # Black results
        if [ "$BLACK_FAILED" = "true" ]; then
          echo "### ‚ùå Black (Code Formatting)" >> lint-summary.md
          echo "\`\`\`" >> lint-summary.md
          cat black-results.txt >> lint-summary.md 2>/dev/null || echo "Failed to format code with black" >> lint-summary.md
          echo "\`\`\`" >> lint-summary.md
          echo "**Fix:** Run \`black src/\` to auto-format your code." >> lint-summary.md
          echo "" >> lint-summary.md
        else
          echo "### ‚úÖ Black (Code Formatting) - PASSED" >> lint-summary.md
          echo "" >> lint-summary.md
        fi

        # Flake8 results
        if [ "$FLAKE8_FAILED" = "true" ]; then
          echo "### ‚ùå Flake8 (Code Quality)" >> lint-summary.md
          echo "\`\`\`" >> lint-summary.md
          cat flake8-results.txt >> lint-summary.md 2>/dev/null || echo "Code quality issues found" >> lint-summary.md
          echo "\`\`\`" >> lint-summary.md
          echo "**Fix:** Address the code quality issues shown above." >> lint-summary.md
          echo "" >> lint-summary.md
        else
          echo "### ‚úÖ Flake8 (Code Quality) - PASSED" >> lint-summary.md
          echo "" >> lint-summary.md
        fi

        # isort results
        if [ "$ISORT_FAILED" = "true" ]; then
          echo "### ‚ùå isort (Import Sorting)" >> lint-summary.md
          echo "\`\`\`" >> lint-summary.md
          cat isort-results.txt >> lint-summary.md 2>/dev/null || echo "Import sorting issues found" >> lint-summary.md
          echo "\`\`\`" >> lint-summary.md
          echo "**Fix:** Run \`isort --profile=black src/\` to auto-sort imports." >> lint-summary.md
          echo "" >> lint-summary.md
        else
          echo "### ‚úÖ isort (Import Sorting) - PASSED" >> lint-summary.md
          echo "" >> lint-summary.md
        fi

        # MyPy results
        if [ "$MYPY_FAILED" = "true" ]; then
          echo "### ‚ö†Ô∏è MyPy (Type Checking)" >> lint-summary.md
          echo "\`\`\`" >> lint-summary.md
          head -20 mypy-results.txt >> lint-summary.md 2>/dev/null || echo "Type checking issues found" >> lint-summary.md
          echo "\`\`\`" >> lint-summary.md
          echo "**Fix:** Add missing type annotations and fix type errors." >> lint-summary.md
          echo "" >> lint-summary.md
        else
          echo "### ‚úÖ MyPy (Type Checking) - PASSED" >> lint-summary.md
          echo "" >> lint-summary.md
        fi

        # Bandit results
        if [ "$BANDIT_FAILED" = "true" ]; then
          echo "### ‚ùå Bandit (Security)" >> lint-summary.md
          echo "\`\`\`" >> lint-summary.md
          cat bandit-results.json >> lint-summary.md 2>/dev/null || echo "Security issues found" >> lint-summary.md
          echo "\`\`\`" >> lint-summary.md
          echo "**Fix:** Address security issues found by Bandit." >> lint-summary.md
          echo "" >> lint-summary.md
        else
          echo "### ‚úÖ Bandit (Security) - PASSED" >> lint-summary.md
          echo "" >> lint-summary.md
        fi

        # Overall status
        if [ "$BLACK_FAILED" = "true" ] || [ "$FLAKE8_FAILED" = "true" ] || [ "$ISORT_FAILED" = "true" ] || [ "$BANDIT_FAILED" = "true" ]; then
          echo "## üö® Action Required" >> lint-summary.md
          echo "Some linting checks failed. Please fix the issues above and push your changes." >> lint-summary.md
        else
          echo "## ‚úÖ All Linting Checks Passed!" >> lint-summary.md
        fi

    - name: Comment PR with results
      if: always() && github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');

          // Read lint summary
          let lintSummary = '';
          try {
            lintSummary = fs.readFileSync('lint-summary.md', 'utf8');
          } catch (error) {
            lintSummary = '## üîç Linting Results\nUnable to generate linting summary.';
          }

          // Generate body
          const body = '# ü§ñ Automated Code Review\n\n' +
            lintSummary + '\n\n' +
            '---\n' +
            '*This comment was automatically generated by GitHub Actions. Check the [Actions tab](' + context.payload.repository.html_url + '/actions) for detailed logs.*';

          // Find existing comment to update
          const comments = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });

          const existingComment = comments.data.find(comment =>
            comment.user.login === 'github-actions[bot]' &&
            comment.body.includes('ü§ñ Automated Code Review')
          );

          if (existingComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: existingComment.id,
              body: body
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
          }

  docker:
    name: üê≥ Docker Build
    runs-on: ubuntu-latest
    needs: [test, lint]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')

    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: |
          ghcr.io/${{ github.repository }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}

    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and push meshtopo-gateway image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: deploy/Dockerfile
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}

    - name: Test Docker images
      run: |
        # Build test image
        docker build --target test -f deploy/Dockerfile -t meshtopo-test:${{ github.sha }} .
        # Run tests in test image
        docker run --rm meshtopo-test:${{ github.sha }}
