# Meshtopo Gateway Service Configuration
# This configuration file demonstrates the core functionality of the enhanced system

# MQTT Broker Configuration
mqtt:
    broker: "mqtt.example.com"          # MQTT broker hostname or IP
    port: 8883                          # MQTT broker port (8883 for SSL, 1883 for non-SSL)
    username: "meshtopo_user"           # MQTT broker username
    password: "your_mqtt_password"      # MQTT broker password
    topic: "msh/REGION/2/json/+/+"             # MQTT topic pattern for Meshtastic messages
    ssl: true                           # Enable SSL/TLS for MQTT connection
    keepalive: 60                       # MQTT keepalive interval in seconds

# CalTopo API Configuration
caltopo:
    group: "MESH-TEAM-ALPHA"            # CalTopo group identifier
    map_id: ""                          # Selected map ID (set via web UI)

    # CalTopo Team API configuration (for map selection feature)
    team_api:
        enabled: true                    # Enable Team API integration
        credential_id: "ABC123DEF456"   # CalTopo service account credential ID
        secret_key: "base64_encoded_secret_key_here"  # CalTopo service account secret key

# User accounts for web UI authentication
# Generate password hashes using: python3 src/web_ui/utils/password.py 'your_password'
users:
    - username: "admin"
      password_hash: "$2b$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/LewdBPj4J8Kz8Kz8K"  # Replace with actual bcrypt hash
      role: "admin"
      caltopo_credentials:
          credential_id: "ADMIN_CRED_123"
          secret_key: "admin_secret_key_base64"
          accessible_maps: ["map-alpha-1", "map-alpha-2", "map-alpha-3"]

    - username: "team_lead"
      password_hash: "$2b$12$XYZ789GHI012JKL345MNO456PQR789STU012VWX345YZA678BCD901"  # Replace with actual bcrypt hash
      role: "admin"
      caltopo_credentials:
          credential_id: "LEAD_CRED_456"
          secret_key: "lead_secret_key_base64"
          accessible_maps: ["map-alpha-1", "map-alpha-2"]

    - username: "operator1"
      password_hash: "$2b$12$DEF456GHI789JKL012MNO345PQR678STU901VWX234YZA567BCD890"  # Replace with actual bcrypt hash
      role: "user"
      caltopo_credentials:
          credential_id: "OP1_CRED_789"
          secret_key: "op1_secret_key_base64"
          accessible_maps: ["map-alpha-1"]

    - username: "operator2"
      password_hash: "$2b$12$GHI789JKL012MNO345PQR678STU901VWX234YZA567BCD890DEF123"  # Replace with actual bcrypt hash
      role: "user"
      caltopo_credentials:
          credential_id: "OP2_CRED_012"
          secret_key: "op2_secret_key_base64"
          accessible_maps: ["map-alpha-2"]

# Mapping of Meshtastic hardware IDs to CalTopo device IDs
nodes:
    "!823a4edc":                        # Meshtastic hardware ID
        device_id: "TEAM-LEAD"          # CalTopo device identifier
        description: "Team Lead Radio"
        enabled: true

    "!a4b8c2f0":                        # Meshtastic hardware ID
        device_id: "COMMS-1"            # CalTopo device identifier
        description: "Primary Communications"
        enabled: true

    "!b5c9d3e1":                        # Meshtastic hardware ID
        device_id: "COMMS-2"            # CalTopo device identifier
        description: "Secondary Communications"
        enabled: false                  # Disabled node

    "!c6d0e4f2":                        # Meshtastic hardware ID
        device_id: "FIELD-OP"           # CalTopo device identifier
        description: "Field Operations"
        enabled: true

# Logging Configuration
logging:
    level: "INFO"                       # Log level: DEBUG, INFO, WARNING, ERROR, CRITICAL
    file:
        enabled: true                   # Enable file logging
        path: "/var/log/meshtopo/meshtopo.log"  # Log file path
        max_size: "10MB"                # Maximum log file size
        backup_count: 5                 # Number of backup files to keep
    web_ui:
        level: "INFO"                   # Web UI specific log level
        access_log: true                # Enable access logging

# Web UI Configuration
web_ui:
    host: "0.0.0.0"                    # Web UI bind address
    port: 5000                          # Web UI port
    secret_key: "your-secret-key-change-this-in-production"  # Flask secret key
    session:
        timeout: 3600                   # Session timeout in seconds (1 hour)
        secure: true                    # Use secure cookies (HTTPS only)
        httponly: true                  # HTTP-only cookies
    rate_limit:
        enabled: true                   # Enable rate limiting
        requests_per_minute: 60         # Global rate limit
        login_attempts_per_minute: 5    # Login attempt rate limit

# SSL/TLS Configuration
ssl:
    enabled: true                       # Enable SSL/TLS termination
    cert_file: "/etc/ssl/certs/meshtopo.crt"    # SSL certificate file
    key_file: "/etc/ssl/private/meshtopo.key"   # SSL private key file
    # Alternative: Use Let's Encrypt with Traefik (see docker-compose.yml)

# Optional: MQTT Broker Configuration (if using integrated broker)
mqtt_broker:
    enabled: false                      # Enable integrated MQTT broker
    port: 1883                          # MQTT broker port
    persistence: true                    # Enable persistence
    authentication:
        enabled: true                   # Enable MQTT authentication
        users:
            - username: "meshtopo_user"
              password: "mqtt_password"
              acl: "readwrite"          # Access control: read, write, readwrite
    ssl:
        enabled: false                  # Enable SSL for MQTT broker
        cert_file: "/etc/ssl/certs/mqtt.crt"
        key_file: "/etc/ssl/private/mqtt.key"

# Optional: Advanced Configuration
advanced:
    # Position forwarding settings
    position_forwarding:
        enabled: true                   # Enable position forwarding to CalTopo
        interval: 30                    # Minimum interval between position updates (seconds)
        max_distance: 100               # Maximum distance to trigger update (meters)

    # Message filtering
    message_filtering:
        enabled: true                   # Enable message filtering
        allowed_types: ["position", "text", "telemetry"]  # Allowed message types
        blocked_nodes: []               # List of blocked node IDs

    # Performance settings
    performance:
        max_concurrent_connections: 100 # Maximum concurrent connections
        connection_timeout: 30          # Connection timeout (seconds)
        retry_attempts: 3               # Number of retry attempts
        retry_delay: 5                  # Delay between retries (seconds)

# Environment-specific overrides
# Uncomment and modify for different environments

# Development Environment
# web_ui:
#     host: "127.0.0.1"
#     port: 5000
#     session:
#         secure: false
# ssl:
#     enabled: false

# Production Environment
# web_ui:
#     host: "0.0.0.0"
#     port: 443
#     session:
#         secure: true
# ssl:
#     enabled: true
#     cert_file: "/etc/letsencrypt/live/meshtopo.example.com/fullchain.pem"
#     key_file: "/etc/letsencrypt/live/meshtopo.example.com/privkey.pem"

# Docker Environment
# web_ui:
#     host: "0.0.0.0"
#     port: 5000
# logging:
#     file:
#         path: "/app/logs/meshtopo.log"
